# -*- coding: utf-8 -*-
"""dashboard.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1_ZRcLzXgtkmdwLqkiuZQ8UlsGBd4hh6M
"""

# Commented out IPython magic to ensure Python compatibility.
# %%writefile dashboard.py

import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

# ========================
# PAGE CONFIG
# ========================
st.set_page_config(layout="wide")
st.title("Beijing Air Quality Dashboard (2013–2017)")

# ========================
# LOAD DATA
# ========================
@st.cache_data
def load_data():
    df = pd.read_parquet("dashboard/main_data.parquet")
    return df

df = load_data()

# ========================
# SIDEBAR FILTER
# ========================
st.sidebar.header("Filter Data")

selected_station = st.sidebar.multiselect(
    "Select Station",
    sorted(df["station"].unique()),
    default=sorted(df["station"].unique())
)

selected_year = st.sidebar.multiselect(
    "Select Year",
    sorted(df["year"].unique()),
    default=sorted(df["year"].unique())
)

filtered_df = df[
    (df["station"].isin(selected_station)) &
    (df["year"].isin(selected_year))
]

# ========================
# NAVIGATION
# ========================
menu = st.sidebar.radio(
    "Select Analysis",
    ["Trend Analysis",
     "Seasonal Pattern",
     "Meteorological Impact",
     "Geospatial Analysis"]
)

# ========================
# 1️⃣ TREND ANALYSIS
# ========================
if menu == "Trend Analysis":

    st.subheader("Annual PM2.5 Trend")

    yearly = (
        filtered_df
        .groupby("year", observed=True)["PM2.5"]
        .mean()
        .reset_index()
    )

    fig, ax = plt.subplots()
    sns.lineplot(data=yearly, x="year", y="PM2.5", marker="o", ax=ax)
    ax.set_ylabel("Average PM2.5")
    st.pyplot(fig)


# ========================
# 2️⃣ SEASONAL PATTERN
# ========================
elif menu == "Seasonal Pattern":

    st.subheader("Monthly PM2.5 Pattern")

    monthly = (
        filtered_df
        .groupby("month", observed=True)["PM2.5"]
        .mean()
        .reset_index()
    )

    fig, ax = plt.subplots()
    sns.lineplot(data=monthly, x="month", y="PM2.5", marker="o", ax=ax)
    ax.set_ylabel("Average PM2.5")
    st.pyplot(fig)


# ========================
# 3️⃣ METEOROLOGICAL IMPACT
# ========================
elif menu == "Meteorological Impact":

    st.subheader("PM2.5 vs Meteorological Variables")

    col1, col2 = st.columns(2)

    with col1:
        fig1, ax1 = plt.subplots()
        sns.scatterplot(data=filtered_df, x="WSPM", y="PM2.5", alpha=0.3, ax=ax1)
        ax1.set_title("Wind Speed vs PM2.5")
        st.pyplot(fig1)

    with col2:
        fig2, ax2 = plt.subplots()
        sns.scatterplot(data=filtered_df, x="TEMP", y="PM2.5", alpha=0.3, ax=ax2)
        ax2.set_title("Temperature vs PM2.5")
        st.pyplot(fig2)


# ========================
# 4️⃣ GEOSPATIAL ANALYSIS
# ========================
elif menu == "Geospatial Analysis":

    st.subheader("Spatial Distribution of PM2.5")

    station_avg = (
        filtered_df
        .groupby(["station","lat","lon"], observed=True)["PM2.5"]
        .mean()
        .reset_index()
    )

    fig, ax = plt.subplots(figsize=(7,6))

    sc = ax.scatter(
        station_avg["lon"],
        station_avg["lat"],
        c=station_avg["PM2.5"],
        cmap="Reds",
        s=300,
        edgecolor="black"
    )

    cbar = plt.colorbar(sc, ax=ax)
    cbar.set_label("Average PM2.5")

    ax.set_xlabel("Longitude")
    ax.set_ylabel("Latitude")

    st.pyplot(fig)